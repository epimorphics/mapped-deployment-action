# Mapped deployment action

A composite github action used to build and push an image to ECR.
Designed for use alongside [epimorphics/deployment-mapper](https://github.com/epimorphics/deployment-mapper).

   * Creates the ECR repository if it doesn't exist, setting access policy to organization-wide
   * Determines a tag for the image to push
   * Builds the image
   * Pushes it to ECR repository with the given tags

## Inputs

| Input | Description |
|---|---|
| `access_key_id` | AWS credentials key id |
| `secret_access_key` | AWS credentials secret access key |
| `image` | Name of the image to build as generated by deployment mapper |
| `required` | AWS region of ECR as extracted by deployment mapper |
| `accountid` | AWS account id of the ECR as extracted by deployment mapper |

## Example usage

```yaml
name: Mapped deployment
on:
  push: {}

jobs:
  mapped-deploy:
    name: mapped-deployment
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2
    - name: "Check for mapped deployment"
      id: mapper
      uses: epimorphics/deployment-mapper@v1.3
      with:
        ref: "${{github.ref}}"

    - name: "Build and push image"
      if: steps.mapper.outputs.image != ''
      uses: epimorphics/mapped-deployment-action@master
      with:
        image: "${{ steps.mapper.outputs.image }}"
        region: "${{ steps.mapper.outputs.region }}"
        accountid: "${{ steps.mapper.outputs.accountid }}"
        AWS_ACCESS_KEY_ID: ${{ secrets.BUILD_EPI_EXPT_AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.BUILD_EPI_EXPT_AWS_SECRET_ACCESS_KEY }}
```

## Tag choice

The action tags the image with `latest` and with with unique tag based on the git tag and sha:

   * if the head of the git repo matches a git tag then that is used as the image tag
   * otherwise, finds the most recent git tag and creates an image tag based on that, plus number of commits since that tag, plus short sha of commit
   * otherwise, if there is no tag, then uses the short sha of the commit

The first two choices correspond to simply `git describe` and generate tags such as `1.0` and `v0.11-34-gebfad28`.
