name: 'Mapped deployment action'
description: 'Build and deploy docker image to ECR based a declarative deployment mapping'
inputs:
  access_key_id:  
    description: 'AWS credentials key id'
    required: true
  secret_access_key:  
    description: 'AWS credentials secret access key'
    required: true
  image:
    description: 'Name of the image to build as generated by deployment mapper'
    required: true
  region:
    description: 'AWS region of ECR as extracted by deployment mapper'
    required: true
  accountid:
    description: 'AWS account id ECR as extracted by deployment mapper'
    required: true
    
runs:
  using: "composite"
  steps: 
    - name: "Create repository if needed"
      env:
        image: "${{ inputs.image }}"
        region: "${{ inputs.region }}"
        accountid: "${{ inputs.accountid }}"
        AWS_ACCESS_KEY_ID: "${{ inputs.access_key_id }}"
        AWS_SECRET_ACCESS_KEY: "${{ inputs.secret_access_key }}"
      run: $scripts/create-ecr.sh
      shell: bash

    - name: "Determine tag"
      id: choosetag
      run: |
        git fetch --prune --unshallow --tags
        tag=$( if git describe > /dev/null 2>&1 ; then   git describe; else   git rev-parse --short HEAD; fi )
        echo "::set-output name=tag::${tag}"
      shell: bash

    - name: "Build and push image"
      env:
        image: "${{ inputs.image }}"
        region: "${{ inputs.region }}"
        accountid: "${{ inputs.accountid }}"
        tags: "latest,${{ steps.choosetag.outputs.tag }}"
        AWS_ACCESS_KEY_ID: "${{ inputs.access_key_id }}"
        AWS_SECRET_ACCESS_KEY: "${{ inputs.secret_access_key }}"
      run: $scripts/build-and-push.sh
      shell: bash
